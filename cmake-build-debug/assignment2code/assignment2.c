/* assignment2.c
 * Geanne Barkmeijer (s2615371), Tessa Bouws (s3547558)
 * 18 February 2019
 * Contains functions from recognizeExp.c, Gerard Renardel, 29 January 2014
 *
 * In this file a recognizer acceptExpression2 is definined that can recognize
 * arithmetical expressions generated by the following BNF grammar:
 *
 * <expression>  ::= <term> { '+'  <term> | '-' <term> }
 *
 * <term>       ::= <factor> { '*' <factor> | '/' <factor> }
 *
 * <factor>     ::= <number> | <identifier> | '(' <expression> ')'
 *
 * Input for the recognizer is the token list constructed by the scanner (in scanner.c).
 * For the recognition of a token list the method of *recursive descent* is used.
 * It relies on the use of three functions for the recognition and processing of
 * terms, factors and expressions, respectively.
 * These three functions are defined with mutual recursion, corresponding with the
 * structure of the BNF grammar.
 */

#include <stdio.h>  /* getchar, printf */
#include <stdlib.h> /* NULL */
#include "scanner.h"
//#include "recognizeExp.c"

int acceptNumber2(List *lp);

int acceptIdentifier2(List *lp);

int acceptCharacter2(List *lp, char c);

int acceptExpression2(List *lp);

int acceptTerm2(List *lp);

int acceptEquation(List *lp);
//void recognizeEquation();

/* The functions acceptNumber2, acceptIdentifier2 and acceptCharacter2 have as
 * (first) argument a pointer to an token list; moreover acceptCharacter2 has as
 * second argument a character. They check whether the first token
 * in the list is a number, an identifier or the given character, respectively.
 * When that is the case, they yield the value 1 and the pointer points to the rest of
 * the token list. Otherwise they yield 0 and the pointer remains unchanged.
 */

int acceptNumber2(List *lp) {
    if (*lp != NULL && (*lp)->tt == Number) {
        *lp = (*lp)->next;
        return 1;
    }
    return 0;
}

int acceptIdentifier2(List *lp) {
    if (*lp != NULL && (*lp)->tt == Identifier) {
        *lp = (*lp)->next;
        return 1;
    }
    return 0;
}

int acceptCharacter2(List *lp, char c) {
    if (*lp != NULL && (*lp)->tt == Symbol && ((*lp)->t).symbol == c) {
        *lp = (*lp)->next;
        return 1;
    }
    return 0;
}

/* The functions acceptFactor, acceptTerm2 and acceptExpression2 have as
 * argument a pointer to a token list. They check whether the token list
 * has an initial segment that can be recognized as factor, term or expression, respectively.
 * When that is the case, they yield the value 1 and the pointer points to the rest of
 * the token list. Otherwise they yield 0 and the pointer remains unchanged.
 */

// <term> ::= <nat> | [ <nat> ] <identifier> [ ‘^’ <nat> ]
int acceptTerm2(List *lp) {
    if (acceptIdentifier2(lp)) {
        if (acceptCharacter2(lp, '^')) {
            if (acceptNumber2(lp)) {
                return 1;
            }
            return 0;
        }
        return 1;
    }
    if (acceptNumber2(lp)) {
        if (acceptIdentifier2(lp)) {
            if (acceptCharacter2(lp, '^')) {
                if (acceptCharacter2(lp, '-')) {
                    if (acceptNumber2(lp)) {
                        return 1;
                    }
                    return 0;
                }
            }
            return 1;
        }
        return 1;
    }
    return 0;
}

// <expression> ::= [ ‘–’ ] <term> { ‘+’ <term> | ‘–’ <term> } .
int acceptExpression2(List *lp) {
    if (acceptTerm2(lp)) {
        while (acceptCharacter2(lp, '+') || acceptCharacter2(lp, '-')) {
            if (!acceptTerm2(lp)) {
                return 0;
            }
        } /* no + or -, so we reached the end of the expression */
        return 1;
    } else if (acceptCharacter2(lp, '-')) {
        return acceptExpression2(lp);
    }
    return 0;
}

int acceptEquation(List *lp) {
    if (acceptExpression2(lp) && acceptCharacter2(lp, '=') && acceptExpression2(lp)) {
        return 1;
    }
    return 0;
}

// <equation> ::= <expression> ‘=’ <expression> .
int acceptEquation2(List *lp) {
    if (acceptExpression2(lp) && acceptCharacter2(lp, '=') && acceptExpression2(lp)) {
        return 1;
    }
    return 0;
}


int checkVarAndDegree(List *tl) {
    char ident, ident2;
    int degree = 0;
    // Find first identifier and its degree
    while ((*tl) != NULL && (*tl)->tt != Identifier) {
        (*tl) = (*tl)->next;
    }
    ident = *((*tl)->t).identifier;
    if ((*tl) != NULL) {
        (*tl) = (*tl)->next;
    }
    if ((*tl) != NULL && ((*tl)->t).symbol != '^') {
        degree = 1;
    }
    if ((*tl) != NULL && ((*tl)->t).symbol == '^' && (((*tl)->next)->t).number > degree) {
        degree = ((*tl)->next)->t.number;
    }
    // Check if more variables
    while ((*tl) != NULL) {
        while ((*tl) != NULL && (*tl)->tt != Identifier) {
            (*tl) = (*tl)->next;
        }
        if ((*tl) != NULL) {
            ident2 = *((*tl)->t).identifier;
            if (ident != ident2) {
                return 0;
            }
            (*tl) = (*tl)->next;
        }
        if ((*tl) != NULL && ((*tl)->t).symbol == '^' && (((*tl)->next)->t).number > degree) {
            degree = (((*tl)->next)->t).number;
        }
    }
    return degree;
}

/* The function recognizeEquations demonstrates the recognizer. */
void recognizeEquations2() {
    char *ar;
    List tl, tl1, tl2;
    printf("give an equation: ");
    ar = readInput();
    while (ar[0] != '!') {
        tl = tokenList(ar);
        //printf("the token list is ");
        printList(tl);
        tl1 = tl;
        tl2 = tl;
        if (acceptEquation2(&tl1) && tl1 == NULL) {
            printf("this is an equation");
            int x = checkVarAndDegree(&tl2);
            if (x == 0) {
                printf(", but not in 1 variable\n");
            } else {
                printf(" in 1 variable of degree %d\n", x);
            }
        } else {
            printf("this is not an equation\n");
        }
        free(ar);
        freeTokenList(tl);
        printf("\ngive an equation: ");
        ar = readInput();
    }
    free(ar);
    printf("good bye\n");
}

// void recognizeEquations2() {
//   char *ar;
//   List tl, tl1;
//   printf("give an equation: ");
//   ar = readInput();
//   while (ar[0] != '!') {
//     tl = tokenList(ar);
//     printf("the token list is ");
//     printList(tl);
//     tl1 = tl;
//     if ( acceptEquation(&tl1) && tl1 == NULL ) {
//       if (countVariables(tl) == 1) {
//         printf("this is an equation in 1 variable of degree %d", degree(tl));
//       } else {
//         printf("this is an equation, but not in 1 variable\n");
//       }
//     } else {
//       printf("this is not an equation\n");
//     }
//     free(ar);
//     freeTokenList(tl);
//     printf("\ngive an equation: ");
//     ar = readInput();
//   }
//   free(ar);
//   printf("good bye\n");
// }

// void recognizeTerms() {
//   char *ar;
//   List tl, tl1;
//   printf("give a term: ");
//   ar = readInput();
//   while (ar[0] != '!') {
//     tl = tokenList(ar);
//     printf("the token list is ");
//     printList(tl);
//     tl1 = tl;
//     if ( acceptTerm2(&tl1) && tl1 == NULL ) {
//       printf("this is a term");
//     } else {
//       printf("this is not a term\n");
//     }
//     free(ar);
//     freeTokenList(tl);
//     printf("\ngive a term: ");
//     ar = readInput();
//   }
//   free(ar);
//   printf("good bye\n");
// }

int main(int argc, char *argv[]) {
    recognizeEquations2();
    return 0;
}
